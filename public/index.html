<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trivia App + Chat (Socket.IO)</title>
  <style>
    /* === Estilos generales === */
    body {
      font-family: system-ui, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h2 { color: #333; margin-bottom: 1rem; }

    /* === Formularios === */
    form, #chatContainer {
      background: #fff;
      padding: 1.2rem;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      width: 350px;
      margin-bottom: 1.2rem;
    }
    input, button {
      width: 100%;
      padding: 0.6rem;
      margin: 0.3rem 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
    }
    button {
      background: #4caf50;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #43a047; }

    #logoutBtn { background: #e53935; }

    /* === Dashboard === */
    #dashboard, #chatContainer { display: none; }
    #output {
      background: #fafafa;
      border: 1px solid #ddd;
      padding: 0.8rem;
      border-radius: 8px;
      text-align: left;
      white-space: pre-wrap;
      max-height: 200px;
      overflow: auto;
    }

    /* === Chat === */
    #chatMessages {
      border: 1px solid #ccc;
      border-radius: 5px;
      height: 200px;
      overflow-y: auto;
      padding: 0.5rem;
      background: #fafafa;
      text-align: left;
      margin-bottom: 0.5rem;
    }
    .msg { margin-bottom: 0.4rem; }
    .msg span { font-weight: bold; color: #2c3e50; }
  </style>
</head>
<body>
  <h2>Trivia App + Chat ðŸ’¬</h2>

  <!-- === FORMULARIO LOGIN === -->
  <form id="loginForm">
    <h3>Iniciar SesiÃ³n</h3>
    <input type="email" id="loginEmail" placeholder="Correo" required />
    <input type="password" id="loginPassword" placeholder="ContraseÃ±a" required />
    <button type="submit">Entrar</button>
  </form>

  <!-- === FORMULARIO REGISTRO === -->
  <form id="registerForm">
    <h3>Registrarse</h3>
    <input type="email" id="registerEmail" placeholder="Correo" required />
    <input type="password" id="registerPassword" placeholder="ContraseÃ±a" required />
    <button type="submit">Crear cuenta</button>
  </form>

  <!-- === PANEL PRINCIPAL (DESPUÃ‰S DE LOGIN) === -->
  <div id="dashboard">
    <h3>Bienvenido ðŸ‘‹</h3>
    <button id="logoutBtn">Cerrar sesiÃ³n</button>

    <hr />
    <h4>Crear Sala</h4>
    <input type="text" id="topic" placeholder="Tema (ej: historia, cine)" required />
    <input type="number" id="quantity" placeholder="Cantidad de preguntas (5â€“20)" min="5" max="20" value="5" />
    <input type="number" id="maxPlayers" placeholder="MÃ¡x jugadores (2â€“10)" min="2" max="10" value="4" />
    <button id="createRoomBtn">Crear</button>

    <h4>Unirse a Sala</h4>
    <input type="text" id="joinCode" placeholder="CÃ³digo de sala" />
    <button id="joinRoomBtn">Unirse</button>

    <h4>InformaciÃ³n de Sala</h4>
    <pre id="output"></pre>
  </div>

  <!-- === CHAT === -->
  <div id="chatContainer">
    <h3>Chat de la Sala ðŸ’¬</h3>
    <div id="chatMessages"></div>
    <form id="chatForm">
      <input id="chatInput" placeholder="Escribe un mensaje..." autocomplete="off" />
      <button type="submit">Enviar</button>
    </form>
  </div>

  <!-- === Cliente Socket.IO === -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    /****************************************************
     * CONFIGURACIÃ“N GLOBAL
     ****************************************************/
    const SERVER_URL = "http://localhost:4000"; // Cambia segÃºn tu entorno
    const API_BASE = "http://localhost:4000/api/v1"; // Prefijo de tus rutas REST
    let socket = null;
    let currentRoom = null;

    // Referencias a elementos del DOM
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const dashboard = document.getElementById("dashboard");
    const chatContainer = document.getElementById("chatContainer");
    const chatMessages = document.getElementById("chatMessages");
    const chatForm = document.getElementById("chatForm");
    const chatInput = document.getElementById("chatInput");
    const output = document.getElementById("output");

    /****************************************************
     * AUTENTICACIÃ“N BÃSICA
     ****************************************************/
    function checkLogin() {
      const token = localStorage.getItem("token");
      if (token) {
        loginForm.style.display = "none";
        registerForm.style.display = "none";
        dashboard.style.display = "block";
      } else {
        loginForm.style.display = "block";
        registerForm.style.display = "block";
        dashboard.style.display = "none";
        chatContainer.style.display = "none";
      }
    }
    checkLogin();

    // LOGIN
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = loginEmail.value;
      const password = loginPassword.value;

      const res = await fetch(`${API_BASE}/auth/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password }),
      });
      const data = await res.json();
      if (res.ok) {
        localStorage.setItem("token", data.token);
        alert("Inicio de sesiÃ³n exitoso âœ…");
        checkLogin();
      } else {
        alert(data.message || "Error al iniciar sesiÃ³n");
      }
    });

    // REGISTRO
    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = registerEmail.value;
      const password = registerPassword.value;

      const res = await fetch(`${API_BASE}/auth/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password }),
      });
      const data = await res.json();
      if (res.ok) {
        alert("Registro exitoso ðŸŽ‰. Ahora puedes iniciar sesiÃ³n.");
      } else {
        alert(data.message || "Error al registrarse");
      }
    });

    // LOGOUT
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("token");
      if (socket) socket.disconnect();
      checkLogin();
    });

    /****************************************************
     * CONEXIÃ“N SOCKET.IO
     ****************************************************/
    function connectSocket() {
      const token = localStorage.getItem("token");
      if (!token) return alert("Debes iniciar sesiÃ³n");
      socket = io(SERVER_URL, { auth: { token } });

      socket.on("connect", () => addSystemMsg("âœ… Conectado al servidor"));
      socket.on("disconnect", () => addSystemMsg("âŒ Desconectado"));
      socket.on("room:update", (data) => {
        addSystemMsg(`ðŸ”” Evento: ${data.event} ${data.player?.name ? '('+data.player.name+')' : ''}`);
      });
      socket.on("room:chat:new", (msg) => addChatMsg(msg.user, msg.message));
    }

    /****************************************************
     * SALAS
     ****************************************************/
    // Crear sala
    document.getElementById("createRoomBtn").addEventListener("click", () => {
      const topic = document.getElementById("topic").value.trim();
      const quantity = parseInt(document.getElementById("quantity").value);
      const maxPlayers = parseInt(document.getElementById("maxPlayers").value);
      if (!topic) return alert("Ingresa un tema.");

      connectSocket();
      socket.emit("room:create", { topic, maxPlayers, quantity }, (res) => {
        if (!res.ok) return alert(res.message || "Error al crear sala");
        currentRoom = res.room.code;
        output.textContent = JSON.stringify(res.room, null, 2);
        startChat(res.room.chatHistory || []);
      });
    });

    // Unirse a sala
    document.getElementById("joinRoomBtn").addEventListener("click", () => {
      const code = document.getElementById("joinCode").value.trim();
      if (!code) return alert("CÃ³digo requerido");

      connectSocket();
      socket.emit("room:join", { code }, (res) => {
        if (!res.ok) return alert(res.message || "Error al unirse a la sala");
        currentRoom = res.room.code;
        output.textContent = JSON.stringify(res.room, null, 2);
        startChat(res.room.chatHistory || []);
      });
    });

    /****************************************************
     * CHAT
     ****************************************************/
    function startChat(chatHistory) {
      chatContainer.style.display = "block";
      chatMessages.innerHTML = "";
      chatHistory.forEach(m => addChatMsg(m.user, m.message));
    }

    // Enviar mensaje
    chatForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const message = chatInput.value.trim();
      if (!message) return;
      socket.emit("room:chat", { code: currentRoom, message }, (ack) => {
        if (!ack.ok) alert(ack.message || "Error enviando mensaje");
      });
      chatInput.value = "";
    });

    // Mostrar mensajes
    function addChatMsg(user, msg) {
      const div = document.createElement("div");
      div.className = "msg";
      div.innerHTML = `<span>${user}:</span> ${msg}`;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    function addSystemMsg(msg) {
      const div = document.createElement("div");
      div.className = "msg";
      div.style.color = "#777";
      div.textContent = msg;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  </script>
</body>
</html>